# Чтение схематик

## Исходники

Классы, существовавшие до 06.2023:
- `server/plugins/char_worldedit.ts` - реализует команды чата для работы со схематиками
- `server/plugins/worldedit/schematic_reader.ts` - реализует высокоуровневую логику чтения схематики. Преобразует блоки в формат madcraft, подготавливает их ко вставке в мир.
- `server/plugins/worldedit/worker.ts`

Классы, добавленные 06.2023:
`server/plugins/worldedit/binary_schematic.ts` - читает схематику в двоичном формате с малыми дополнительными затратами памяти, парсит NBT, возвращает блоки из указанного AABB. Является заменой модуля prismarine-nbt. Но наверное поддерживает меньше форматов, поэтому имеет опцию читать через prismarine-nbt (по-старому).
- `server/plugins/worldedit/schematic_job.ts` - управляет процессом вставки схематики в мир (только новым способом, не через буфер обмена).

## Процесс вставки

Поддерживается 2 типа вставки.

### Вставка через буфер обмена (старый метод)
Загрузить схематику, поместить все ее блоки в буфер обмена класса `WorldEdit`, после чего с ней можно работать как с любыми другими скопированными блоками (например, `/paste`). Это можно использовать:
- для маленьких сематик
- если новый режим не поддерживает конкретный файл (неизвестно, возможно ли такое)

Пример последовательности команд:
`/schem load my_schematic` - загрузка в память (в воркере, без распаковки блоков)
`/schem copy` - распаковка и помещение всех блоков в буфер обмена
`/paste` - вставка
`/schem clear` - выгрузить из памяти схематику. Можно вызвать эту команду в любой момент, хоть сразу после окончания `/paste`. Это не влияет на данные в буфере обмена.

### Создание задачи вставки (новый метод)

Загрузить схематику, запустить процесс ее вставки. Процесс можно приостановить и возобновить.
Пример последовательности команд:
`/schem load my_schematic` - загрузка в память
`/schem start` - начать процесс вставки
`/paste` - начать вставку
...
`/schem info` - проверить как идет процесс вставки
...
`/schem clear` - после завершения процесса вставки (о чем придет сообщение в чат). Если вызвать раньше - вставка прервется, но в мире останутся уже вставленные чанки.

В процессе вставки, схематика распаковывается и передается из воркера в основной поток частями. `SchematicJob` следит, чтобы не число гразных блоков и общее число чанков в памяти не превышало константы `MAX_DIRTY_BLOCKS` и `MAX_CHUNK_ACTORS` в файле `server/plugins/worldedit/schematic_job.ts`. Когда превышает - запрос новых чанков схематики из воркера приостанавливается пока ресурсы снова не освободятся.

Если сервер упадет до завершения вставки, описание задачи и ее прогресс останется в БД - в поле state таблицы world, поле JSON schematicJob. Ее можно вручную возобновить после перезапуска. Но автоматически она не запускается при старте мира (чтобы избежать возможных циклических падений).

### Очистка памяти

Загруженная схематика остается в памяти до завершения мира или до загрузки новой схематики. Чтобы очистить память, нужно вызвать команду:
`/schem clear`
Эта команда также останавливает текущую задачу по вставки схематики и удаляет незавершенную задачу из БД, если она там есть.

### Ограничения на выполнение команды

Цель - предотвратить падение из-за исчерпания памяти, а также ошибки пользователя связанные с вызовом нескольких команд, пока другие выполняются.

В мире может быть одновременно загружена только одна схематика.

Если есть неоконченная работа по вставке, то большинство команд по схематикам отказываются выполнятся, пока пользователь не удалит неоконченную работу через `/schem clear` или не продолжит ее через `/schem resume`. Обоснование такого решения: чтобы снизить вероятность по ошибке оставить не до конца вставленную схематику.

Если сейчас воркер выполняет команду связанную со схематикой, большинство команд отказываются выполнятся и выводят об этом сообщение. Нужно дождаться завершения предыдущей команды и повторить попытку. Обоснование такого решения: если бы команды складировались в очередь, а потом все выполнялись, легко было бы по ошибке создать огромный объем работы или нарушить последовательность действий.

### Дополнительные примеры команд

Справка по командам выводится если ввести `/schem`.
Некоторые примеры:
`/schem load my_schematic true` - использовать старый загрузчик (медленный, много памяти)
`/schem copy true` - скопировать вместе с воздухом (по умолчанию - без)
`/schem start ~ 100 ~` - запустить процесс вставки начиная с Y = 100
`/schem start ~ ~ ~ 90` - запустить процесс вставки, при этом вставлять блоки воздуха до высоты 90 (по умолчанию - не вставляются)
`/schem start ~ ~ ~ true` - запустить процесс вставки, при этом вставлять все блоки воздуха
`/schem pause` - приостановить задачу вставки
`/schem resume` - возобновить задачу вставки (в том числе - существовавшую до падения сервера)
`/schem info` - выдать информацию о загруженной схематике и процессе вставки

## TODO

Лучшие команды: отмена изменений (не полная - но хотя бы просто очистить затронутые чанки), вставка части схематики, более удобное задание положения(?), лучшее решение с воздухом.